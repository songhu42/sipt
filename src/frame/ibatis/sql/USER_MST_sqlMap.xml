<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="USER_MST">
	
    <select id="getCount" parameterClass="java.util.Map" resultClass="int">
		SELECT COUNT(*)
		FROM USER_MST C 
		LEFT OUTER JOIN COM_CODE D ON ( D.PCODE = 'A03' AND C.USER_AGE = D.CODE )
		LEFT OUTER JOIN (
		 SELECT A.USER_ID, COUNT(*) AS BUY_CNT, SUM(A.ADD_MAX_HEART) AS BUY_MAX_HEART_CNT, SUM(D.PRICE) AS BUY_TOT_AMT  
		 FROM BUY_HISTORY A
		 INNER JOIN USER_MST B ON (A.USER_ID = B.USER_ID)  
		 LEFT OUTER JOIN INAPP_ITEM D ON ( B.LOGIN_TYPE = D.APP_GB AND B.DEVICE_TOKEN = D.OS_GB AND A.ITEM_ID = D.ITEM_ID )  
		 GROUP BY A.USER_ID ) E ON (C.USER_ID = E.USER_ID )  
        <isNotEmpty property="WHERE_OPTION">
        $WHERE_OPTION$
        </isNotEmpty>
    </select>

    <select id="getListPage" parameterClass="java.util.Map" resultClass="com.humanval.sipt.dao.User_mst">
		SELECT C.USER_ID, C.USER_NIC, C.STAGE, C.USER_GRADE, C.USER_LVL, C.USER_GOLD, C.USER_EXP, C.WP_ITEM, C.LOGIN_TYPE, C.DEVICE_TOKEN, 
		C.JOIN_DT, C.MAX_HEART_CNT, C.HEART_CNT, C.PASS_ITEM_CNT, C.TIME_ITEM_CNT, C.EVENT_DAYS, C.EVENT_DT, C.APP_VER, 
		C.USER_AGE, D.NAME AS USER_AGE_NM, IFNULL(C.INVITOR_ID,0) AS INVITOR_ID, IFNULL(E.BUY_CNT,0) AS BUY_CNT, IFNULL(E.BUY_TOT_AMT, 0) AS BUY_TOT_AMT, 
		(SELECT COUNT(*) FROM GAME_RES WHERE USER_ID = C.USER_ID) AS TOT_GAME_CNT,  
		(SELECT COUNT(*) FROM GAME_RES WHERE USER_ID = C.USER_ID AND DATE_FORMAT(REG_DT,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d') ) AS CUR_GAME_CNT 
		FROM USER_MST C 
		LEFT OUTER JOIN COM_CODE D ON ( D.PCODE = 'A03' AND C.USER_AGE = D.CODE )
		LEFT OUTER JOIN (
		 SELECT A.USER_ID, COUNT(*) AS BUY_CNT, SUM(A.ADD_MAX_HEART) AS BUY_MAX_HEART_CNT, SUM(D.PRICE) AS BUY_TOT_AMT  
		 FROM BUY_HISTORY A
		 INNER JOIN USER_MST B ON (A.USER_ID = B.USER_ID)  
		 LEFT OUTER JOIN INAPP_ITEM D ON ( B.LOGIN_TYPE = D.APP_GB AND B.DEVICE_TOKEN = D.OS_GB AND A.ITEM_ID = D.ITEM_ID )  
		 GROUP BY A.USER_ID ) E ON (C.USER_ID = E.USER_ID )  

        <isNotEmpty property="WHERE_OPTION">
        $WHERE_OPTION$
        </isNotEmpty>
        ORDER BY C.USER_ID DESC 
        LIMIT #START_NO#, #PAGE_CNT#
        
    </select>
    
    
    <select id="getList" parameterClass="java.util.Map" resultClass="com.humanval.sipt.dao.User_mst">
		SELECT C.USER_ID, C.USER_NIC, C.STAGE, C.USER_GRADE, C.USER_LVL, C.USER_GOLD, C.USER_EXP, C.WP_ITEM, C.LOGIN_TYPE, C.DEVICE_TOKEN, 
		C.JOIN_DT, C.MAX_HEART_CNT, C.HEART_CNT, C.PASS_ITEM_CNT, C.TIME_ITEM_CNT, C.EVENT_DAYS, C.EVENT_DT, C.APP_VER, 
		C.USER_AGE, D.NAME AS USER_AGE_NM, IFNULL(C.INVITOR_ID,0) AS INVITOR_ID, IFNULL(E.BUY_CNT,0) AS BUY_CNT, IFNULL(E.BUY_TOT_AMT, 0) AS BUY_TOT_AMT, 
		(SELECT COUNT(*) FROM GAME_RES WHERE USER_ID = C.USER_ID) AS TOT_GAME_CNT,  
		(SELECT COUNT(*) FROM GAME_RES WHERE USER_ID = C.USER_ID AND DATE_FORMAT(REG_DT,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d') ) AS CUR_GAME_CNT 
		FROM USER_MST C 
		LEFT OUTER JOIN COM_CODE D ON ( D.PCODE = 'A03' AND C.USER_AGE = D.CODE )
		LEFT OUTER JOIN (
		 SELECT A.USER_ID, COUNT(*) AS BUY_CNT, SUM(A.ADD_MAX_HEART) AS BUY_MAX_HEART_CNT, SUM(D.PRICE) AS BUY_TOT_AMT  
		 FROM BUY_HISTORY A
		 INNER JOIN USER_MST B ON (A.USER_ID = B.USER_ID)  
		 LEFT OUTER JOIN INAPP_ITEM D ON ( B.LOGIN_TYPE = D.APP_GB AND B.DEVICE_TOKEN = D.OS_GB AND A.ITEM_ID = D.ITEM_ID )  
		 GROUP BY A.USER_ID ) E ON (C.USER_ID = E.USER_ID )  

        <isNotEmpty property="WHERE_OPTION">
        $WHERE_OPTION$
        </isNotEmpty>
        ORDER BY C.USER_ID DESC 
        
    </select>
    
    <select id="getView" parameterClass="java.util.Map" resultClass="com.humanval.sipt.dao.User_mst">
		SELECT C.USER_ID, C.USER_NIC, C.STAGE, C.USER_GRADE, C.USER_LVL, C.USER_GOLD, C.USER_EXP, C.WP_ITEM, C.LOGIN_TYPE, C.DEVICE_TOKEN, 
		C.JOIN_DT, C.MAX_HEART_CNT, C.HEART_CNT, C.PASS_ITEM_CNT, C.TIME_ITEM_CNT, C.EVENT_DAYS, C.EVENT_DT, C.APP_VER, 
		C.USER_AGE, D.NAME AS USER_AGE_NM, IFNULL(C.INVITOR_ID,0) AS INVITOR_ID, IFNULL(E.BUY_CNT,0) AS BUY_CNT, IFNULL(E.BUY_TOT_AMT, 0) AS BUY_TOT_AMT, 
		(SELECT COUNT(*) FROM GAME_RES WHERE USER_ID = C.USER_ID) AS TOT_GAME_CNT,  
		(SELECT COUNT(*) FROM GAME_RES WHERE USER_ID = C.USER_ID AND DATE_FORMAT(REG_DT,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d') ) AS CUR_GAME_CNT 
		FROM USER_MST C 
		LEFT OUTER JOIN COM_CODE D ON ( D.PCODE = 'A03' AND C.USER_AGE = D.CODE )
		LEFT OUTER JOIN (
		 SELECT A.USER_ID, COUNT(*) AS BUY_CNT, SUM(A.ADD_MAX_HEART) AS BUY_MAX_HEART_CNT, SUM(D.PRICE) AS BUY_TOT_AMT  
		 FROM BUY_HISTORY A
		 INNER JOIN USER_MST B ON (A.USER_ID = B.USER_ID)  
		 LEFT OUTER JOIN INAPP_ITEM D ON ( B.LOGIN_TYPE = D.APP_GB AND B.DEVICE_TOKEN = D.OS_GB AND A.ITEM_ID = D.ITEM_ID )  
		 GROUP BY A.USER_ID ) E ON (C.USER_ID = E.USER_ID )  
		
        WHERE C.USER_ID = #USER_ID# 
    </select>
            
    
</sqlMap>